# =========================================================================
# Deploy PR-CYBR-M3SH-BBS Dashboard to GitHub Pages
# =========================================================================
#
# This workflow deploys the /dashboard directory to GitHub Pages.
#
# IMPORTANT: GitHub Pages must be configured to use GitHub Actions!
#
# To enable this workflow:
# 1. Go to your repository Settings
# 2. Navigate to Pages (Settings â†’ Pages)
# 3. Under "Build and deployment", set Source to "GitHub Actions"
# 4. Save the changes
#
# The dashboard will then be available at:
# https://pr-cybr.github.io/PR-CYBR-M3SH-BBS/
#
# =========================================================================

name: Deploy dashboard to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'dashboard/**'
      - 'data/**'
      - 'assets/**'
      - 'config/**'
      - 'scripts/**'
      - '.github/workflows/dashboard-pages.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build and Deploy Dashboard
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Generate BBS outputs
        run: |
          # Generate PR-MESH-BBS bulletins
          python scripts/pr_mesh_bbs_generate.py --verbose --include-expired
          
          # Generate PR-CYBR-BBS channel payloads
          python scripts/pr_cybr_bbs_generate.py --verbose
          
          # Export dashboard state
          python scripts/export_dashboard_state.py --verbose
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      # Copy data files to dashboard for static serving
      - name: Prepare dashboard assets
        run: |
          # Create directories in dashboard for data
          mkdir -p dashboard/out/pr-mesh-bbs
          mkdir -p dashboard/out/pr-cybr-bbs
          mkdir -p dashboard/data/status
          mkdir -p dashboard/assets/qr/pr-cybr-bbs
          
          # Copy generated output files
          if [ -d "out/pr-mesh-bbs" ]; then
            cp -r out/pr-mesh-bbs/* dashboard/out/pr-mesh-bbs/ 2>/dev/null || echo "No pr-mesh-bbs output files"
          fi
          
          if [ -d "out/pr-cybr-bbs" ]; then
            cp -r out/pr-cybr-bbs/* dashboard/out/pr-cybr-bbs/ 2>/dev/null || echo "No pr-cybr-bbs output files"
          fi
          
          # Copy node status data
          if [ -f "data/status/nodes.json" ]; then
            cp data/status/nodes.json dashboard/data/status/
          fi
          
          # Copy QR code assets
          if [ -d "assets/qr/pr-cybr-bbs" ]; then
            cp -r assets/qr/pr-cybr-bbs/* dashboard/assets/qr/pr-cybr-bbs/ 2>/dev/null || echo "No QR code files"
          fi
          
          echo "Dashboard assets prepared successfully"
          ls -la dashboard/
          ls -la dashboard/out/pr-mesh-bbs/ 2>/dev/null || true
          ls -la dashboard/out/pr-cybr-bbs/ 2>/dev/null || true
      
      - name: Upload dashboard artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dashboard
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
